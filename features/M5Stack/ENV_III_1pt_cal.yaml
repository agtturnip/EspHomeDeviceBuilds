# ENV III sensor package (SHT3xD + QMP6988).
# Required substitution (set in build): env_iii_i2c_bus (I2C bus id).

substitutions:
  env_iii_temp_id: "env_temp"
  env_iii_hum_id: "env_hum"
  env_iii_press_id: "env_press"

# Persistent calibration offsets stored in flash.
globals:
  - id: temp_offset
    type: float
    restore_value: yes
    initial_value: "0"
  - id: hum_offset
    type: float
    restore_value: yes
    initial_value: "0"

# User-adjustable offsets exposed to HA.
number:
  - platform: template
    name: "Temp Offset (°F)"
    icon: mdi:tune-vertical
    unit_of_measurement: "°F"
    mode: box
    min_value: -10
    max_value: 10
    step: 0.1
    optimistic: true
    restore_value: true
    set_action:
      - lambda: |-
          id(temp_offset) = x;

  - platform: template
    name: "Humidity Offset (%)"
    icon: mdi:tune-vertical
    unit_of_measurement: "%"
    mode: box
    min_value: -10
    max_value: 10
    step: 0.1
    optimistic: true
    restore_value: true
    set_action:
      - lambda: |-
          id(hum_offset) = x;

# ENV III sensors on a selectable I2C bus.
sensor:
  - platform: sht3xd
    i2c_id: ${env_iii_i2c_bus} # Set in build to match board/expander bus id.
    address: 0x44
    temperature:
      name: Temperature
      id: ${env_iii_temp_id}
      accuracy_decimals: 2
      filters:
        - lambda: |-
            // Convert C to F and apply calibration offset.
            return (x * 9.0 / 5.0) + 32.0 + id(temp_offset);
        - or:
            # Reduce noise while preserving meaningful changes.
            - throttle: 5min
            - delta: 0.3
      unit_of_measurement: "°F"
      device_class: temperature
      state_class: measurement
    humidity:
      name: Humidity
      id: ${env_iii_hum_id}
      accuracy_decimals: 2
      filters:
        - lambda: |-
            // Apply calibration offset.
            return x + id(hum_offset);
        - or:
            # Reduce noise while preserving meaningful changes.
            - throttle: 5min
            - delta: 0.3
      unit_of_measurement: "%"
      device_class: humidity
      state_class: measurement
    update_interval: 30s

  - platform: qmp6988
    i2c_id: ${env_iii_i2c_bus} # Set in build to match board/expander bus id.
    address: 0x70
    pressure:
      name: Pressure
      id: ${env_iii_press_id}
      filters:
        - multiply: 0.02953
        - or:
            # Reduce noise while preserving meaningful changes.
            - throttle: 5min
            - delta: 0.3
      unit_of_measurement: "inHg"
      device_class: pressure
      state_class: measurement
    update_interval: 30s
